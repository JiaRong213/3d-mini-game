<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D射击游戏</title>
    <script src="https://unpkg.com/vue@3.2.47/dist/vue.global.js"></script>
    <script src="https://unpkg.com/three@0.132.2/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.132.2/examples/js/controls/PointerLockControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #game-container { position: relative; width: 100vw; height: 100vh; }
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        #crosshair::before, #crosshair::after {
            content: '';
            position: absolute;
            background: white;
        }
        #crosshair::before {
            width: 2px;
            height: 20px;
            left: 9px;
            top: 0;
        }
        #crosshair::after {
            width: 20px;
            height: 2px;
            left: 0;
            top: 9px;
        }
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 1rem;
            color: white;
            pointer-events: none;
        }
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
        }
        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="game-container" ref="gameContainer">
            <div id="crosshair"></div>
            <div id="ui" class="flex justify-between">
                <div>生命值: {{ health }}/100</div>
                <div>分数: {{ score }}</div>
                <div>弹药: {{ ammo }}/30</div>
            </div>
            
            <div id="start-screen" v-if="!gameStarted">
                <h1 class="text-4xl font-bold mb-8">3D射击游戏</h1>
                <p class="mb-4">使用WASD移动，鼠标瞄准，左键射击</p>
                <button 
                    @click="startGame" 
                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition"
                >
                    开始游戏
                </button>
            </div>
            
            <div id="game-over" :style="{display: gameOver ? 'flex' : 'none'}">
                <h1 class="text-4xl font-bold mb-8">游戏结束</h1>
                <p class="text-2xl mb-4">最终分数: {{ score }}</p>
                <button 
                    @click="restartGame" 
                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition"
                >
                    再玩一次
                </button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, watch } = Vue;
        
        createApp({
            setup() {
                const gameContainer = ref(null);
                const gameStarted = ref(false);
                const gameOver = ref(false);
                const health = ref(100);
                const score = ref(0);
                const ammo = ref(30);
                
                // Three.js相关变量
                let scene, camera, renderer, controls;
                let cubes = [];
                let enemies = [];
                let bullets = [];
                let clock = new THREE.Clock();
                let lastShotTime = 0;
                let shootSound, hitSound;
                
                // 初始化游戏
                const initGame = () => {
                    // 创建场景
                    scene = new THREE.Scene();
                    scene.background = new THREE.Color(0x87CEEB); // 天空蓝
                    
                    // 创建相机
                    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                    camera.position.y = 1.6; // 人物高度
                    
                    // 创建渲染器
                    renderer = new THREE.WebGLRenderer({ antialias: true });
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    gameContainer.value.appendChild(renderer.domElement);
                    
                    // 添加控制器
                    controls = new THREE.PointerLockControls(camera, document.body);
                    
                    // 添加光源
                    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
                    scene.add(ambientLight);
                    
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(1, 1, 1);
                    scene.add(directionalLight);
                    
                    // 添加地面
                    const groundGeometry = new THREE.PlaneGeometry(100, 100);
                    const groundMaterial = new THREE.MeshStandardMaterial({ 
                        color: 0x3a5f0b,
                        roughness: 0.8
                    });
                    const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                    ground.rotation.x = -Math.PI / 2;
                    scene.add(ground);
                    
                    // 添加围墙
                    addWalls();
                    
                    // 添加随机立方体作为障碍物
                    for (let i = 0; i < 20; i++) {
                        addRandomCube();
                    }
                    
                    // 加载音效
                    const audioLoader = new THREE.AudioLoader();
                    shootSound = new THREE.Audio(new THREE.AudioListener());
                    hitSound = new THREE.Audio(new THREE.AudioListener());
                    
                    audioLoader.load('https://assets.codepen.io/21542/howler-pistol-shot.mp3', (buffer) => {
                        shootSound.setBuffer(buffer);
                    });
                    
                    audioLoader.load('https://assets.codepen.io/21542/howler-hit.mp3', (buffer) => {
                        hitSound.setBuffer(buffer);
                    });
                    
                    // 添加事件监听器
                    document.addEventListener('click', onMouseClick);
                    document.addEventListener('keydown', onKeyDown);
                    window.addEventListener('resize', onWindowResize);
                    
                    // 开始游戏循环
                    animate();
                };
                
                // 添加围墙
                const addWalls = () => {
                    const wallMaterial = new THREE.MeshStandardMaterial({ 
                        color: 0x8B4513,
                        roughness: 0.7
                    });
                    
                    // 前后墙
                    for (let i = -1; i <= 1; i += 2) {
                        const wallGeometry = new THREE.BoxGeometry(100, 5, 2);
                        const wall = new THREE.Mesh(wallGeometry, wallMaterial);
                        wall.position.z = i * 50;
                        scene.add(wall);
                    }
                    
                    // 左右墙
                    for (let i = -1; i <= 1; i += 2) {
                        const wallGeometry = new THREE.BoxGeometry(2, 5, 100);
                        const wall = new THREE.Mesh(wallGeometry, wallMaterial);
                        wall.position.x = i * 50;
                        scene.add(wall);
                    }
                };
                
                // 添加随机立方体
                const addRandomCube = () => {
                    const geometry = new THREE.BoxGeometry(
                        Math.random() * 3 + 1, 
                        Math.random() * 3 + 1, 
                        Math.random() * 3 + 1
                    );
                    
                    const colors = [0xff0000, 0x00ff00, 0x0000ff, 0xffff00, 0xff00ff];
                    const material = new THREE.MeshStandardMaterial({ 
                        color: colors[Math.floor(Math.random() * colors.length)],
                        roughness: 0.7,
                        metalness: 0.3
                    });
                    
                    const cube = new THREE.Mesh(geometry, material);
                    
                    // 随机位置，确保不会太靠近玩家起始位置
                    let x, z;
                    do {
                        x = Math.random() * 80 - 40;
                        z = Math.random() * 80 - 40;
                    } while (Math.abs(x) < 10 && Math.abs(z) < 10);
                    
                    cube.position.set(x, geometry.parameters.height / 2, z);
                    scene.add(cube);
                    cubes.push(cube);
                };
                
                // 添加敌人
                const addEnemy = () => {
                    const geometry = new THREE.CylinderGeometry(0.5, 0.5, 2, 16);
                    const material = new THREE.MeshStandardMaterial({ 
                        color: 0xff0000,
                        roughness: 0.7
                    });
                    
                    const enemy = new THREE.Mesh(geometry, material);
                    
                    // 随机位置，确保不会太靠近玩家
                    let x, z;
                    do {
                        x = Math.random() * 80 - 40;
                        z = Math.random() * 80 - 40;
                    } while (Math.sqrt(x*x + z*z) < 15);
                    
                    enemy.position.set(x, 1, z);
                    enemy.speed = Math.random() * 0.02 + 0.01;
                    enemy.health = 3;
                    scene.add(enemy);
                    enemies.push(enemy);
                };
                
                // 射击
                const shoot = () => {
                    if (ammo.value <= 0) return;
                    
                    ammo.value--;
                    
                    // 播放射击音效
                    if (shootSound.isPlaying) {
                        shootSound.stop();
                    }
                    shootSound.play();
                    
                    // 创建子弹
                    const bulletGeometry = new THREE.SphereGeometry(0.1, 8, 8);
                    const bulletMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00 });
                    const bullet = new THREE.Mesh(bulletGeometry, bulletMaterial);
                    
                    // 从相机位置发射
                    bullet.position.copy(camera.position);
                    
                    // 获取相机方向
                    const direction = new THREE.Vector3();
                    camera.getWorldDirection(direction);
                    
                    // 设置子弹速度和方向
                    bullet.velocity = direction.clone().multiplyScalar(1);
                    bullet.userData.distance = 0;
                    
                    scene.add(bullet);
                    bullets.push(bullet);
                };
                
                // 鼠标点击事件
                const onMouseClick = (event) => {
                    if (!gameStarted.value || gameOver.value) return;
                    
                    if (controls.isLocked) {
                        const currentTime = clock.getElapsedTime();
                        if (currentTime - lastShotTime > 0.2) { // 射击冷却
                            shoot();
                            lastShotTime = currentTime;
                        }
                    } else {
                        controls.lock();
                    }
                };
                
                // 键盘事件
                const onKeyDown = (event) => {
                    if (!gameStarted.value || gameOver.value) return;
                    
                    // R键重新装弹
                    if (event.key.toLowerCase() === 'r' && ammo.value < 30) {
                        ammo.value = 30;
                    }
                };
                
                // 窗口大小调整
                const onWindowResize = () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                };
                
                // 游戏循环
                const animate = () => {
                    requestAnimationFrame(animate);
                    
                    if (!gameStarted.value || gameOver.value) return;
                    
                    const delta = clock.getDelta();
                    
                    // 更新敌人
                    updateEnemies(delta);
                    
                    // 更新子弹
                    updateBullets(delta);
                    
                    // 检测碰撞
                    checkCollisions();
                    
                    // 随机生成敌人
                    if (Math.random() < 0.01 && enemies.length < 10) {
                        addEnemy();
                    }
                    
                    renderer.render(scene, camera);
                };
                
                // 更新敌人
                const updateEnemies = (delta) => {
                    enemies.forEach(enemy => {
                        // 敌人朝玩家移动
                        const direction = new THREE.Vector3();
                        direction.subVectors(camera.position, enemy.position).normalize();
                        enemy.position.x += direction.x * enemy.speed;
                        enemy.position.z += direction.z * enemy.speed;
                        
                        // 确保敌人在地面上
                        enemy.position.y = 1;
                        
                        // 敌人朝向玩家
                        enemy.lookAt(camera.position);
                        enemy.rotation.x = 0;
                        enemy.rotation.z = 0;
                    });
                };
                
                // 更新子弹
                const updateBullets = (delta) => {
                    for (let i = bullets.length - 1; i >= 0; i--) {
                        const bullet = bullets[i];
                        bullet.position.add(bullet.velocity);
                        bullet.userData.distance += bullet.velocity.length();
                        
                        // 如果子弹飞得太远，移除它
                        if (bullet.userData.distance > 50) {
                            scene.remove(bullet);
                            bullets.splice(i, 1);
                        }
                    }
                };
                
                // 检测碰撞
                const checkCollisions = () => {
                    // 子弹与敌人碰撞
                    for (let i = bullets.length - 1; i >= 0; i--) {
                        const bullet = bullets[i];
                        
                        for (let j = enemies.length - 1; j >= 0; j--) {
                            const enemy = enemies[j];
                            
                            if (bullet.position.distanceTo(enemy.position) < 1) {
                                // 击中敌人
                                enemy.health--;
                                
                                // 播放击中音效
                                if (hitSound.isPlaying) {
                                    hitSound.stop();
                                }
                                hitSound.play();
                                
                                // 移除子弹
                                scene.remove(bullet);
                                bullets.splice(i, 1);
                                
                                // 如果敌人生命值为0，移除敌人并增加分数
                                if (enemy.health <= 0) {
                                    scene.remove(enemy);
                                    enemies.splice(j, 1);
                                    score.value += 10;
                                }
                                
                                break;
                            }
                        }
                    }
                    
                    // 敌人与玩家碰撞
                    for (let i = enemies.length - 1; i >= 0; i--) {
                        const enemy = enemies[i];
                        
                        if (camera.position.distanceTo(enemy.position) < 1.5) {
                            // 敌人攻击玩家
                            health.value -= 1;
                            
                            // 如果玩家生命值为0，游戏结束
                            if (health.value <= 0) {
                                gameOver.value = true;
                                controls.unlock();
                            }
                            
                            // 击退敌人
                            const direction = new THREE.Vector3();
                            direction.subVectors(enemy.position, camera.position).normalize();
                            enemy.position.add(direction.multiplyScalar(0.5));
                        }
                    }
                };
                
                // 开始游戏
                const startGame = () => {
                    gameStarted.value = true;
                    health.value = 100;
                    score.value = 0;
                    ammo.value = 30;
                    gameOver.value = false;
                    
                    // 初始化Three.js场景
                    initGame();
                    
                    // 添加初始敌人
                    for (let i = 0; i < 3; i++) {
                        addEnemy();
                    }
                };
                
                // 重新开始游戏
                const restartGame = () => {
                    // 清除场景
                    while (gameContainer.value.firstChild) {
                        gameContainer.value.removeChild(gameContainer.value.firstChild);
                    }
                    
                    // 重置变量
                    cubes = [];
                    enemies = [];
                    bullets = [];
                    
                    // 开始新游戏
                    startGame();
                };
                
                return {
                    gameContainer,
                    gameStarted,
                    gameOver,
                    health,
                    score,
                    ammo,
                    startGame,
                    restartGame
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
